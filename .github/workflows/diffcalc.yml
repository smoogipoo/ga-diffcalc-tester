name: Difficulty Calculation

on:
  issue_comment:
    types: [ created ]
  workflow_dispatch:
    inputs:
      osu-a:
        description: "The source build of ppy/osu"
        type: string
        required: false
        default: 'https://github.com/ppy/osu'
      osu-b:
        description: "The target build of ppy/osu"
        type: string
        required: true
      ruleset:
        description: "The ruleset to process"
        type: choice
        required: true
        options:
          - osu
          - taiko
          - catch
          - mania
      converts:
        description: "Include converted beatmaps"
        type: boolean
        required: false
        default: true
      ranked-only:
        description: "Only ranked beatmaps"
        type: boolean
        required: false
        default: true
      generators:
        description: "Comma-separated list of generators (available: [sr, pp, score])"
        type: string
        required: false
        default: 'pp,sr'
      difficulty-calculator-a:
        description: "The source build of ppy/osu-difficulty-calculator"
        type: string
        required: false
        default: 'https://github.com/ppy/osu-difficulty-calculator'
      difficulty-calculator-b:
        description: "The target build of ppy/osu-difficulty-calculator"
        type: string
        required: false
        default: 'https://github.com/ppy/osu-difficulty-calculator'
      score-processor-a:
        description: "The source build of ppy/osu-queue-score-statistics"
        type: string
        required: false
        default: 'https://github.com/ppy/osu-queue-score-statistics'
      score-processor-b:
        description: "The target build of ppy/osu-queue-score-statistics"
        type: string
        required: false
        default: 'https://github.com/ppy/osu-queue-score-statistics'

permissions:
  pull-requests: write

env:
  COMMENT_TAG: execution-${{ github.run_id }}-${{ github.run_number }}-${{ github.run_attempt }}
  GENERATOR_DIR: 'diffcalc-sheet-generator'
  GENERATOR_ENV: 'diffcalc-sheet-generator/.env'
  GOOGLE_CREDS_FILE: 'diffcalc-sheet-generator/google-credentials.json'

jobs:
  create-comment:
    name: Create PR comment
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '!diffcalc') && github.event.comment.author_association == 'OWNER' }}
    steps:
      - name: Create comment
        uses: thollander/actions-comment-pull-request@v2
        with:
          comment_tag: ${{ env.COMMENT_TAG }}
          message: |
            Difficulty calculator is now running... Please wait! (${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            *This comment will update on completion*

  prepare:
    name: Prepare
    needs: create-comment
    runs-on: self-hosted
    if: ${{ always() && (github.event_name == 'workflow_dispatch' || contains(github.event.comment.body, '!diffcalc') && github.event.comment.author_association == 'OWNER') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Checkout diffcalc-sheet-generator
        uses: actions/checkout@v3
        with:
          path: 'diffcalc-sheet-generator'
          repository: 'smoogipoo/diffcalc-sheet-generator'

  setup-environment:
    name: Setup environment
    needs: prepare
    runs-on: self-hosted
    if: ${{ always() && needs.prepare.result == 'success' }}
    steps:
      - name: Add base environment
        run: |
          # Required by diffcalc-sheet-generator
          cp '${{ github.workspace }}/diffcalc-sheet-generator/.env.sample' "${GENERATOR_ENV}"

          # Add GH token
          sed -i 's/^GH_TOKEN=.*$/GH_TOKEN=${{ github.token }}/' "${GENERATOR_ENV}"

          # Add Google credentials
          echo '${{ secrets.DIFFCALC_GOOGLE_CREDENTIALS }}' | base64 -d > "${GOOGLE_CREDS_FILE}"

          # Add repository variables
          env | grep -E '^DIFFCALC_' | while read -r line; do
              opt=$(echo ${line} | cut -d '=' -f1 | cut -d '_' -f2-)
              val=$(echo ${line} | cut -d '=' -f2-)
              sed -i "s;^${opt}=.*$;${opt}=${val};" "${GENERATOR_ENV}"
          done

      - name: Add pull-request environment
        if: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request }}
        run: |
          sed -i "s;^OSU_B=.*$;OSU_B=${{ github.event.issue.pull_request.url }};" "${GENERATOR_ENV}"

      - name: Add comment environment
        if: ${{ github.event_name == 'issue_comment' }}
        run: |
          # Add comment environment
          echo '${{ github.event.comment.body }}' | sed -r 's/\r$//' | grep -E '^\w+=' | while read -r line; do
              opt=$(echo ${line} | cut -d '=' -f1)
              sed -i "s;^${opt}=.*$;${line};" "${GENERATOR_ENV}"
          done

      - name: Add dispatch environment
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          # Add dispatch environment
          sed -i 's;^OSU_A=.*$;OSU_A=${{ inputs.osu-a }};' "${GENERATOR_ENV}"
          sed -i 's;^OSU_B=.*$;OSU_B=${{ inputs.osu-b }};' "${GENERATOR_ENV}"
          sed -i 's/^RULESET=.*$/RULESET=${{ inputs.ruleset }}/' "${GENERATOR_ENV}"
          sed -i 's/^GENERATORS=.*$/GENERATORS=${{ inputs.generators }}/' "${GENERATOR_ENV}"
          sed -i 's;^DIFFICULTY_CALCULATOR_A=.*$;DIFFICULTY_CALCULATOR_A=${{ inputs.difficulty-calculator-a }};' "${GENERATOR_ENV}"
          sed -i 's;^DIFFICULTY_CALCULATOR_B=.*$;DIFFICULTY_CALCULATOR_B=${{ inputs.difficulty-calculator-b }};' "${GENERATOR_ENV}"
          sed -i 's;^SCORE_PROCESSOR_A=.*$;SCORE_PROCESSOR_A=${{ inputs.score-processor-a }};' "${GENERATOR_ENV}"
          sed -i 's;^SCORE_PROCESSOR_B=.*$;SCORE_PROCESSOR_B=${{ inputs.score-processor-b }};' "${GENERATOR_ENV}"
          if [[ '${{ inputs.converts }}' == 'true' ]]; then
              sed -i 's/^NO_CONVERTS=.*$/NO_CONVERTS=0/' "${GENERATOR_ENV}"
          else
              sed -i 's/^NO_CONVERTS=.*$/NO_CONVERTS=1/' "${GENERATOR_ENV}"
          fi
          if [[ '${{ inputs.ranked-only }}' == 'true' ]]; then
              sed -i 's/^RANKED_ONLY=.*$/RANKED_ONLY=1/' "${GENERATOR_ENV}"
          else
              sed -i 's/^RANKED_ONLY=.*$/RANKED_ONLY=0/' "${GENERATOR_ENV}"
          fi

  download-scores:
    name: Download scores
    needs: setup-environment
    runs-on: self-hosted
    if: ${{ always() && needs.setup-environment.result == 'success' }}
    steps:
      - name: Download & Extract
        run: |
          RULESET=$(cat ${GENERATOR_ENV} | grep -E '^RULESET=' | cut -d '=' -f2-)
          echo "Ruleset: ${RULESET}"

          PERFORMANCE_DATA_NAME=$(curl -s "https://data.ppy.sh/" | grep "performance_${RULESET}_top_1000\b" | tail -1 | awk -F "'" '{print $2}' | sed 's/\.tar\.bz2//g')
          echo "Data: ${PERFORMANCE_DATA_NAME}"

          echo "Downloading database dump ${PERFORMANCE_DATA_NAME}.."
          wget -q -nc "https://data.ppy.sh/${PERFORMANCE_DATA_NAME}.tar.bz2"

          echo 'Extracting ${PERFORMANCE_DATA_NAME}...'
          tar -I lbzip2 -xf "${PERFORMANCE_DATA_NAME}.tar.bz2"

          rm -r "${GENERATOR_DIR}/sql/${RULESET}"
          mv "${PERFORMANCE_DATA_NAME}" "${GENERATOR_DIR}/sql/${RULESET}"

  download-beatmaps:
    name: Download beatmaps
    needs: prepare
    runs-on: self-hosted
    if: ${{ always() && needs.prepare.result == 'success' }}
    steps:
      - name: Download & Extract
        run: |
          BEATMAPS_DATA_NAME=$(curl -s "https://data.ppy.sh/" | grep "osu_files" | tail -1 | awk -F "'" '{print $2}' | sed 's/\.tar\.bz2//g')
          echo "Beatmaps: ${BEATMAPS_DATA_NAME}"

          echo "Downloading beatmap dump ${BEATMAPS_DATA_NAME}.."
          wget -q -nc "https://data.ppy.sh/${BEATMAPS_DATA_NAME}.tar.bz2"

          echo 'Extracting ${BEATMAPS_DATA_NAME}...'
          tar -I lbzip2 -xf "${BEATMAPS_DATA_NAME}.tar.bz2"

          rm -r "${GENERATOR_DIR}/beatmaps"
          mv "${BEATMAPS_DATA_NAME}" "${GENERATOR_DIR}/beatmaps"

  generator:
    name: Run generator
    needs: [setup-environment, download-scores, download-beatmaps]
    runs-on: self-hosted
    if: ${{ always() && needs.download-scores.result == 'success' && needs.download-beatmaps.result == 'success' }}
    outputs:
      TARGET: ${{ steps.run.outputs.TARGET }}
      SPREADSHEET_LINK: ${{ steps.run.outputs.SPREADSHEET_LINK }}
    steps:
      - name: Run
        id: run
        run: |
          cd "${{ github.workspace }}/${GENERATOR_DIR}"
          docker-compose up --build generator

          link=$(docker-compose logs generator -n 10 | grep 'http' | sed -E 's/^.*(http.*)$/\1/')
          target=$(cat "${GENERATOR_ENV}" | grep -E '^OSU_B=' | cut -d '=' -f2-)

          echo "TARGET=${target}" >> "${GITHUB_OUTPUT}"
          echo "SPREADSHEET_LINK=${link}" >> "${GITHUB_OUTPUT}"

      - name: Shutdown
        if: ${{ always() }}
        run: |
          cd "${{ github.workspace }}/${GENERATOR_DIR}"
          docker-compose down

      - name: Output info
        if: ${{ success() }}
        run: |
          echo "Target: ${{ steps.run.outputs.TARGET }}"
          echo "Spreadsheet: ${{ steps.run.outputs.SPREADSHEET_LINK }}"

  update-comment:
    name: Update PR comment
    needs: generator
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '!diffcalc') && github.event.comment.author_association == 'OWNER' }}
    steps:
      - name: Update comment on success
        if: ${{ needs.generator.result == 'success' }}
        uses: thollander/actions-comment-pull-request@v2
        with:
          comment_tag: ${{ env.COMMENT_TAG }}
          mode: upsert
          create_if_not_exists: false
          message: |
            Target: ${{ needs.generator.outputs.TARGET }}
            Spreadsheet: ${{ needs.generator.outputs.SPREADSHEET_LINK }}

      - name: Update comment on failure
        if: ${{ needs.generator.result == 'failure' }}
        uses: thollander/actions-comment-pull-request@v2
        with:
          comment_tag: ${{ env.COMMENT_TAG }}
          mode: upsert
          create_if_not_exists: false
          message: |
            Difficulty calculation failed: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}