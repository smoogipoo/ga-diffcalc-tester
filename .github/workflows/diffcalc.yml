name: Difficulty Calculation
on:
  issue_comment:
    types: [ created ]

jobs:
  diffcalc:
    name: Run
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '!diffcalc') && (github.event.comment.author_association == 'MEMBER' || github.event.comment.author_association == 'OWNER')
    env:
      GENERATOR_DIR: '${{ github.workspace }}/diffcalc-sheet-generator'
      GENERATOR_ENV: '${{ github.workspace }}/diffcalc-sheet-generator/.env'
      GOOGLE_CREDS_FILE: '${{ github.workspace }}/diffcalc-sheet-generator/google-credentials.json'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Checkout diffcalc-sheet-generator
        uses: actions/checkout@v3
        with:
          path: 'diffcalc-sheet-generator'
          repository: 'smoogipoo/diffcalc-sheet-generator'

      - name: Setup environment
        run: |
          # Required by diffcalc-sheet-generator
          cp "${{ github.workspace }}/diffcalc-sheet-generator/.env.sample" "$GENERATOR_ENV"

          # Add default environment
          cat "${{ github.workspace }}/.env" | grep -E "^\w+=" | while read -r line; do
              opt=$(echo $line | awk -F "=" '{print $1}')
              sed -i "s/^${opt}.*$/$line/" "$GENERATOR_ENV"
          done

          # Add comment environment
          echo "${{ github.event.comment.body }}" | sed -r "s/\r$//" | grep -E "^\w+=" | while read -r line; do
              opt=$(echo $line | awk -F "=" '{print $1}')
              sed -i "s/^${opt}.*$/$line/" "$GENERATOR_ENV"
          done

          # Add GH token
          sed -i "s/^GH_TOKEN=.*$/GH_TOKEN=${{ secrets.DIFFCALC_GITHUB_TOKEN }}/" "$GENERATOR_ENV"

          # Add Google credentials
          echo "{{ secrets.DIFFCALC_GOOGLE_CREDENTIALS }}" > "$GOOGLE_CREDS_FILE"
          sed -i "s,^GOOGLE_CREDENTIALS_FILE=.*$,GOOGLE_CREDENTIALS_FILE=$GOOGLE_CREDS_FILE," "$GENERATOR_ENV"

      - name: Setup files
        run: |
          RULESET=$(cat $GENERATOR_ENV | grep "RULESET=" | awk -F "=" '{print $2}')
          echo "Ruleset: $RULESET"

          PERFORMANCE_DATA_NAME=$(curl -s https://data.ppy.sh/ | grep performance_$RULESET_top_1000 | tail -1 | awk -F "'" '{print $2}' | sed 's/\.tar\.bz2//g')
          echo "Data: $PERFORMANCE_DATA_NAME"

          BEATMAPS_DATA_NAME=$(curl -s https://data.ppy.sh/ | grep osu_files | tail -1 | awk -F "'" '{print $2}' | sed 's/\.tar\.bz2//g')
          echo "Beatmaps: $BEATMAPS_DATA_NAME"

          echo "Downloading database dump $PERFORMANCE_DATA_NAME.."
          wget -q -nc https://data.ppy.sh/$PERFORMANCE_DATA_NAME.tar.bz2
          echo "Extracting..."
          tar -xf "$PERFORMANCE_DATA_NAME.tar.bz2"

          rm -r "$GENERATOR_DIR/sql/$RULESET"
          mv "$PERFORMANCE_DATA_NAME" "$GENERATOR_DIR/sql/$RULESET"

          echo "Downloading beatmap dump $BEATMAPS_DATA_NAME.."
          wget -q -nc https://data.ppy.sh/$BEATMAPS_DATA_NAME.tar.bz2
          echo "Extracting..."
          tar -xf $BEATMAPS_DATA_NAME.tar.bz2

          rm -r "$GENERATOR_DIR/beatmaps"
          mv "$BEATMAPS_DATA_NAME" "$GENERATOR_DIR/beatmaps"

      - name: Run generator
        uses: isbang/compose-action@v1.5.1
        with:
          compose-file: "${{ github.workspace }}/diffcalc-sheet-generator/docker-compose.yml"
          up-flags: "--abort-on-container-exit --exit-code-from generator"
